<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Optimization Test - TMDB Crawler</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Glassmorphism Design System -->
    <link href="css/glassmorphism.css?v=1.0" rel="stylesheet">
    <!-- Performance Optimization CSS -->
    <link href="css/performance.css?v=1.0" rel="stylesheet">
</head>
<body>
    <!-- Test Navbar -->
    <nav class="navbar navbar-expand-lg glass-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-speedometer2"></i> æ€§èƒ½ä¼˜åŒ–æµ‹è¯•
            </a>
            <ul class="navbar-nav ms-auto gap-2">
                <li class="nav-item">
                    <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜"></button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Test Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h1 class="mb-3">
                        <i class="bi bi-lightning-charge text-warning"></i> æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½æµ‹è¯•
                    </h1>
                    <p class="text-muted mb-0">
                        æ­¤é¡µé¢ç”¨äºæµ‹è¯•æ‰€æœ‰æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½ï¼ŒåŒ…æ‹¬å›¾ç‰‡æ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨ã€é˜²æŠ–èŠ‚æµç­‰ã€‚
                    </p>
                </div>
            </div>
        </div>

        <!-- Performance Stats -->
        <div class="row mb-4 g-3">
            <div class="col-md-3 col-6">
                <div class="glass-stats">
                    <div class="stat-value" id="memoryUsed">-</div>
                    <div class="stat-label">å†…å­˜ä½¿ç”¨ (MB)</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-stats">
                    <div class="stat-value" id="fps">-</div>
                    <div class="stat-label">å¸§ç‡ (FPS)</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-stats">
                    <div class="stat-value text-success" id="lcp">-</div>
                    <div class="stat-label">LCP (ms)</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="glass-stats">
                    <div class="stat-value text-primary" id="fid">-</div>
                    <div class="stat-label">FID (ms)</div>
                </div>
            </div>
        </div>

        <!-- Test Sections -->
        <div class="row g-4">
            <!-- 1. Lazy Loading Test -->
            <div class="col-12">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-image"></i> 1. å›¾ç‰‡æ‡’åŠ è½½æµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹å›¾ç‰‡æ‡’åŠ è½½æ•ˆæœã€‚å›¾ç‰‡ä¼šåœ¨è¿›å…¥è§†å£å‰ 50px å¼€å§‹åŠ è½½ã€‚
                    </p>
                    <div class="row g-3" id="lazyImageContainer">
                        <!-- Images will be generated by JS -->
                    </div>
                </div>
            </div>

            <!-- 2. Debounce Test -->
            <div class="col-md-6">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-clock-history"></i> 2. é˜²æŠ–æµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        è¾“å…¥æ–‡å­—åç­‰å¾… 300ms æ‰è§¦å‘æœç´¢ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚ã€‚
                    </p>
                    <div class="mb-3">
                        <label class="form-label">æœç´¢ï¼ˆé˜²æŠ– 300msï¼‰</label>
                        <input type="text" class="glass-input w-100" id="debounceInput"
                               placeholder="è¾“å…¥æ–‡å­—æµ‹è¯•é˜²æŠ–...">
                    </div>
                    <div id="debounceOutput" class="p-3 bg-light rounded">
                        <strong>è§¦å‘æ¬¡æ•°ï¼š</strong> <span id="debounceCount">0</span>
                        <div class="text-muted small mt-1" id="debounceLog"></div>
                    </div>
                </div>
            </div>

            <!-- 3. Throttle Test -->
            <div class="col-md-6">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-arrows-angle-expand"></i> 3. èŠ‚æµæµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        æ»šåŠ¨ä¸‹é¢çš„å®¹å™¨ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°æœ€å¤šæ¯ 100ms æ‰§è¡Œä¸€æ¬¡ã€‚
                    </p>
                    <div class="mb-3" style="height: 150px; overflow-y: auto;" id="throttleContainer">
                        <div style="height: 500px; padding: 20px;">
                            <p>æ»šåŠ¨æ­¤å®¹å™¨æµ‹è¯•èŠ‚æµæ•ˆæœ...</p>
                            <p id="throttleOutput">æ»šåŠ¨ä½ç½®: 0px</p>
                            <p>è§¦å‘æ¬¡æ•°: <span id="throttleCount">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Virtual Scroll Test -->
            <div class="col-12">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-list-ul"></i> 4. è™šæ‹Ÿæ»šåŠ¨æµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        æ¸²æŸ“ 10,000 é¡¹æ•°æ®ï¼Œä½†åªæ¸²æŸ“å¯è§éƒ¨åˆ†ï¼Œå¤§å¹…æå‡æ€§èƒ½ã€‚
                    </p>
                    <div class="mb-3">
                        <button class="btn glass-btn glass-btn-primary" id="initVirtualScroll">
                            <i class="bi bi-play-circle"></i> åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨ (10,000 é¡¹)
                        </button>
                        <button class="btn glass-btn" id="destroyVirtualScroll">
                            <i class="bi bi-x-circle"></i> é”€æ¯
                        </button>
                    </div>
                    <div class="glass-card p-2" style="height: 400px; overflow: auto;" id="virtualScrollContainer">
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i>
                            <p class="mt-2">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨</p>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">
                        å¯è§èŒƒå›´: <span id="virtualScrollRange">æœªåˆå§‹åŒ–</span> |
                        æ€»æ•°æ®: <span id="virtualScrollTotal">-</span>
                    </div>
                </div>
            </div>

            <!-- 5. Performance Monitor Test -->
            <div class="col-md-6">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-stopwatch"></i> 5. æ€§èƒ½ç›‘æ§æµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        æµ‹é‡æ“ä½œçš„æ‰§è¡Œæ—¶é—´ã€‚
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn glass-btn glass-btn-primary" id="testHeavyOperation">
                            æµ‹è¯•é‡æ“ä½œ (è®¡ç®—)
                        </button>
                        <button class="btn glass-btn glass-btn-success" id="testDOMOperation">
                            æµ‹è¯• DOM æ“ä½œ
                        </button>
                    </div>
                    <div class="mt-3">
                        <strong>ä¸Šæ¬¡æ“ä½œè€—æ—¶ï¼š</strong>
                        <span id="operationTime" class="text-primary">-</span>
                    </div>
                </div>
            </div>

            <!-- 6. RAF Throttle Test -->
            <div class="col-md-6">
                <div class="glass-card p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-film"></i> 6. RAF èŠ‚æµæµ‹è¯•
                    </h5>
                    <p class="text-muted mb-3">
                        ä½¿ç”¨ requestAnimationFrame èŠ‚æµï¼Œç¡®ä¿åŠ¨ç”»æµç•… (60fps)ã€‚
                    </p>
                    <canvas id="animationCanvas" width="400" height="200" class="w-100 border rounded"></canvas>
                    <div class="mt-2">
                        <button class="btn glass-btn glass-btn-primary" id="startAnimation">
                            <i class="bi bi-play-fill"></i> å¼€å§‹åŠ¨ç”»
                        </button>
                        <button class="btn glass-btn" id="stopAnimation">
                            <i class="bi bi-pause-fill"></i> åœæ­¢
                        </button>
                    </div>
                    <div class="mt-2 text-muted small">
                        å¸§ç‡: <span id="animationFPS">-</span> FPS
                    </div>
                </div>
            </div>
        </div>

        <!-- Core Web Vitals -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="glass-card p-4" style="border-left: 4px solid var(--glass-accent);">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up"></i> Core Web Vitals ç›‘æ§
                    </h5>
                    <p class="mb-3">
                        è¿™äº›æŒ‡æ ‡ä¼šè‡ªåŠ¨æµ‹é‡å¹¶åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼š
                    </p>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="glass-stats">
                                <div class="stat-value" id="vitalLCP">æµ‹é‡ä¸­...</div>
                                <div class="stat-label">LCP (åº” < 2.5s)</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="glass-stats">
                                <div class="stat-value" id="vitalFID">æµ‹é‡ä¸­...</div>
                                <div class="stat-label">FID (åº” < 100ms)</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="glass-stats">
                                <div class="stat-value" id="vitalCLS">æµ‹é‡ä¸­...</div>
                                <div class="stat-label">CLS (åº” < 0.1)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Performance Optimization Toolkit -->
    <script src="js/performance.js?v=1.0"></script>

    <!-- Test Scripts -->
    <script>
    (function() {
        'use strict';

        const { PerformanceUtils, PerformanceMonitor, VirtualScroll } = window.PerformanceToolkit;

        // ========================================
        // 1. Generate Lazy Images
        // ========================================
        const imageContainer = document.getElementById('lazyImageContainer');
        for (let i = 0; i < 6; i++) {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-6';
            col.innerHTML = `
                <div class="glass-card p-2">
                    <img data-lazy="https://picsum.photos/400/300?random=${i}"
                         alt="Lazy load test ${i + 1}"
                         class="img-fluid rounded">
                    <div class="text-center mt-2 small">å›¾ç‰‡ ${i + 1}</div>
                </div>
            `;
            imageContainer.appendChild(col);
        }

        // ========================================
        // 2. Debounce Test
        // ========================================
        const debounceInput = document.getElementById('debounceInput');
        const debounceCount = document.getElementById('debounceCount');
        const debounceLog = document.getElementById('debounceLog');
        let count = 0;

        const debouncedSearch = PerformanceUtils.debounce((value) => {
            count++;
            debounceCount.textContent = count;
            debounceLog.textContent = `æœç´¢: "${value}" - ${new Date().toLocaleTimeString()}`;
        }, 300);

        debounceInput.addEventListener('input', (e) => {
            debouncedSearch(e.target.value);
        });

        // ========================================
        // 3. Throttle Test
        // ========================================
        const throttleContainer = document.getElementById('throttleContainer');
        const throttleOutput = document.getElementById('throttleOutput');
        const throttleCount = document.getElementById('throttleCount');
        let scrollCount = 0;

        const throttledScroll = PerformanceUtils.throttle((e) => {
            scrollCount++;
            throttleOutput.textContent = `æ»šåŠ¨ä½ç½®: ${e.target.scrollTop}px`;
            throttleCount.textContent = scrollCount;
        }, 100);

        throttleContainer.addEventListener('scroll', throttledScroll, { passive: true });

        // ========================================
        // 4. Virtual Scroll Test
        // ========================================
        const initVirtualBtn = document.getElementById('initVirtualScroll');
        const destroyVirtualBtn = document.getElementById('destroyVirtualScroll');
        const virtualContainer = document.getElementById('virtualScrollContainer');
        let virtualList = null;

        initVirtualBtn.addEventListener('click', () => {
            if (virtualList) return;

            const data = Array.from({ length: 10000 }, (_, i) => ({
                id: i + 1,
                name: `æ•°æ®é¡¹ ${i + 1}`,
                value: Math.floor(Math.random() * 1000)
            }));

            virtualList = VirtualScroll.create(virtualContainer, data, {
                itemHeight: 50,
                bufferSize: 5,
                renderItem: (item, index) => {
                    const div = document.createElement('div');
                    div.className = 'glass-card p-2 mb-2';
                    div.style.height = '40px';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'space-between';
                    div.innerHTML = `
                        <span><strong>${item.id}.</strong> ${item.name}</span>
                        <span class="glass-badge glass-badge-primary">${item.value}</span>
                    `;
                    return div;
                },
                onScroll: (state) => {
                    document.getElementById('virtualScrollRange').textContent =
                        `${state.startIndex} - ${state.endIndex}`;
                }
            });

            document.getElementById('virtualScrollTotal').textContent = data.length.toLocaleString();
            initVirtualBtn.disabled = true;
        });

        destroyVirtualBtn.addEventListener('click', () => {
            if (virtualList) {
                virtualList.destroy();
                virtualList = null;
                virtualContainer.innerHTML = `
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i>
                        <p class="mt-2">è™šæ‹Ÿæ»šåŠ¨å·²é”€æ¯</p>
                    </div>
                `;
                initVirtualBtn.disabled = false;
            }
        });

        // ========================================
        // 5. Performance Monitor Test
        // ========================================
        const operationTime = document.getElementById('operationTime');

        document.getElementById('testHeavyOperation').addEventListener('click', () => {
            PerformanceMonitor.start('heavy-op');

            // Simulate heavy computation
            let result = 0;
            for (let i = 0; i < 1000000; i++) {
                result += Math.sqrt(i);
            }

            const duration = PerformanceMonitor.end('heavy-op');
            operationTime.textContent = `${duration.toFixed(2)}ms`;
        });

        document.getElementById('testDOMOperation').addEventListener('click', () => {
            PerformanceMonitor.start('dom-op');

            PerformanceUtils.batchUpdate(() => {
                for (let i = 0; i < 100; i++) {
                    const div = document.createElement('div');
                    div.style.height = '10px';
                    div.style.background = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    virtualContainer.appendChild(div);
                }
            });

            const duration = PerformanceMonitor.end('dom-op');
            operationTime.textContent = `${duration.toFixed(2)}ms`;
        });

        // ========================================
        // 6. Animation Test (RAF Throttle)
        // ========================================
        const canvas = document.getElementById('animationCanvas');
        const ctx = canvas.getContext('2d');
        let animationId = null;
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 0;

        const drawBall = (x, y) => {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.fillStyle = '#7C3AED';
            ctx.fill();
            ctx.closePath();
        };

        const animate = PerformanceUtils.rafThrottle((timestamp) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const progress = (timestamp / 1000) % 2;
            const x = (progress / 2) * canvas.width;
            const y = canvas.height / 2 + Math.sin(timestamp / 200) * 50;

            drawBall(x, y);

            // Calculate FPS
            frameCount++;
            if (timestamp - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = timestamp;
                document.getElementById('animationFPS').textContent = fps;
            }

            animationId = requestAnimationFrame(animate);
        });

        document.getElementById('startAnimation').addEventListener('click', () => {
            if (!animationId) {
                animate(performance.now());
            }
        });

        document.getElementById('stopAnimation').addEventListener('click', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        });

        // ========================================
        // 7. Core Web Vitals Monitoring
        // ========================================
        PerformanceMonitor.monitorCoreWebVitals((metrics) => {
            if (metrics.lcp) {
                document.getElementById('vitalLCP').textContent =
                    `${metrics.lcp.toFixed(0)}ms`;
                document.getElementById('lcp').textContent =
                    `${(metrics.lcp / 1000).toFixed(1)}s`;
            }
            if (metrics.fid) {
                document.getElementById('vitalFID').textContent =
                    `${metrics.fid.toFixed(0)}ms`;
                document.getElementById('fid').textContent =
                    `${metrics.fid.toFixed(0)}ms`;
            }
            if (metrics.cls !== undefined) {
                document.getElementById('vitalCLS').textContent =
                    metrics.cls.toFixed(3);
            }
        });

        // ========================================
        // 8. Memory Monitoring
        // ========================================
        setInterval(() => {
            const memory = PerformanceMonitor.getMemoryUsage();
            if (memory) {
                document.getElementById('memoryUsed').textContent = memory.used;
            }
        }, 2000);

        // ========================================
        // Theme Toggle
        // ========================================
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        const getPreferredTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) return savedTheme;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const setTheme = (theme) => {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        setTheme(getPreferredTheme());

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        }

        console.log('ğŸš€ Performance Test Page Loaded');
    })();
    </script>
</body>
</html>
