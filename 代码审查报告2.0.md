# go-tmdb-crawler 代码审查报告 2.0

## 范围
- 服务层: `services/`
- API 层: `api/`
- 数据层: `models/`, `repositories/`
- 配置与中间件: `config/`, `middleware/`
- 前端: `web/js/`

## 高优先级问题 (High)
1) **潜在空指针导致崩溃**
- 位置: `go-tmdb-crawler/services/telegraph.go`
- 现象: `episode.Show.Name` 依赖 `Preload("Show")`，当调用方未预加载或关联为空时会 panic。
- 建议: 使用 `episode.Show != nil` 判空或改用 `ShowID` + 查询缓存的方式。

2) **后台任务无错误回传/监控，失败静默**
- 位置: `go-tmdb-crawler/api/crawler.go`
- 现象: `RefreshAll`/`CrawlByStatus` 在 goroutine 中执行，失败仅日志不可见，API 端无法跟踪状态。
- 建议: 增加任务队列/状态表，返回 task_id 并提供查询接口；至少记录失败日志并关联请求。

3) **重复写入/数据膨胀风险**
- 位置: `go-tmdb-crawler/services/crawler.go` + `go-tmdb-crawler/repositories/episode.go`
- 现象: `CreateBatch` 不做去重，反复爬取会重复插入同一集。
- 建议: 以 `(show_id, season_number, episode_number)` 建唯一索引并改为 upsert。

## 中优先级问题 (Medium)
4) **分页与过滤逻辑不一致**
- 位置: `go-tmdb-crawler/api/show.go`
- 现象: status 过滤先分页再内存过滤，导致分页数和 total 不准确。
- 建议: repo 层提供按 status 查询/分页。

5) **日期范围边界与时区不明确**
- 位置: `go-tmdb-crawler/services/publisher.go`, `go-tmdb-crawler/repositories/episode.go`
- 现象: `time.Now().Truncate(24*time.Hour)` 默认本地时区，和 TMDB 的日期可能有偏差；range 是否含 endDate 不明确。
- 建议: 统一时区(UTC或配置化)，清晰定义闭区间/开区间。

6) **cron 解析器使用不一致**
- 位置: `go-tmdb-crawler/services/scheduler.go`
- 现象: `cron.WithSeconds()` 使用秒级表达式，但 `ValidateCronSpec` 用 `cron.ParseStandard`(不支持秒)导致校验误判。
- 建议: 使用 `cron.Parse` 搭配 `WithSeconds` 选项，或统一标准格式。

7) **goroutine 无限制并发**
- 位置: `go-tmdb-crawler/services/scheduler.go`
- 现象: 每次调度新起 goroutine，长时间任务会堆积并发。
- 建议: 使用 worker/队列或在任务执行中设置锁/跳过重复任务。

8) **SQLite 兼容性问题**
- 位置: `go-tmdb-crawler/repositories/show.go`
- 现象: `ILIKE` 在 SQLite 不支持，会导致搜索失败。
- 建议: 根据 DB 类型切换 `LIKE`/`ILIKE` 或使用 GORM 的 `Where("LOWER(name) LIKE ?")`。

9) **Markdown 服务中季排序未排序**
- 位置: `go-tmdb-crawler/services/markdown.go`
- 现象: `seasons` 没有排序，输出顺序不稳定。
- 建议: 对 `seasons` 排序后再输出。

## 低优先级问题 (Low)
10) **API Key 存储在 localStorage**
- 位置: `go-tmdb-crawler/web/js/api.js`
- 现象: localStorage 易受 XSS 读取。
- 建议: 尽量改为短期 token + httpOnly cookie，或提高前端 XSS 防护。

11) **配置校验不完整**
- 位置: `go-tmdb-crawler/config/config.go`
- 现象: `APP_PORT`、`DB_PORT` 未做范围校验，`DB_PASSWORD` 为空时仅针对 postgres 检查。
- 建议: 增加端口范围校验和更多配置完整性检查。

12) **Auth 中间件失败记录无淘汰**
- 位置: `go-tmdb-crawler/middleware/auth.go`
- 现象: `failedAttempts` map 永不清理，长期运行可能增长。
- 建议: 定期清理过期记录或设置最大容量。

## 代码质量与可维护性建议
- `go-tmdb-crawler/services/tmdb.go`: 增加重试/限速和更强的错误分类(HTTP 429/5xx)。
- `go-tmdb-crawler/services/crawler.go`: `ParseDate` 解析错误被忽略，建议记录或回退策略。
- `go-tmdb-crawler/services/telegraph.go`: 内容生成依赖 emoji，若输出到纯文本环境建议可配置禁用。

## 建议补充测试
- `CreateBatch` 去重与幂等性测试。
- API `status` 过滤 + 分页一致性测试。
- `GetTodayUpdates` 时区边界测试。
- Markdown 输出顺序稳定性测试。

## 风险总览
- 运行时崩溃: **中高风险** (空指针、goroutine 泄漏)
- 数据一致性: **中风险** (重复插入、分页偏差)
- 兼容性: **中风险** (SQLite ILIKE)
- 安全性: **中低风险** (localStorage key、无任务状态)
