# 代码优化任务清单

来源: `代码审查报告2.0.md`

## 目标
- 将高优问题落地为可执行任务
- 明确优先级、影响范围、验收标准
- 形成可追踪的优化路线图

## 任务清单

### 高优先级 (High)

#### T-01 防止空指针崩溃 (Telegraph 内容生成)
- **问题**: `episode.Show.Name` 依赖 `Preload("Show")`，关联为空时可能 panic
- **影响**: 运行时崩溃，线上风险高
- **范围**: `services/telegraph.go`
- **建议方案**:
  - 生成内容时判空 `episode.Show != nil`
  - 或改为使用 `ShowID` + 显式查询/缓存
- **验收标准**:
  - 无预加载时不崩溃
  - 为空时有合理降级输出

#### T-02 异步任务状态可追踪 (task_id + 查询接口)
- **问题**: 异步任务失败无法从 API 端追踪
- **影响**: 任务失败静默，运维不可观测
- **范围**: `api/crawler.go`, `services/task_manager.go`, `models/crawl_task.go`, `repositories/crawl_task.go`, 路由注册
- **建议方案**:
  - 启动任务返回 `task_id`
  - 提供 `GET /api/v1/crawler/tasks/:id` 查询
  - 持久化任务状态并记录错误信息
- **验收标准**:
  - `refresh-all`/`crawl-by-status` 返回 task_id
  - 任务完成/失败可查询
  - 失败时 API 返回错误信息

#### T-03 防重复写入 (Episode 幂等性)
- **问题**: `CreateBatch` 重复插入导致数据膨胀
- **影响**: 数据一致性风险、中长期容量风险
- **范围**: `services/crawler.go`, `repositories/episode.go`, DB schema
- **建议方案**:
  - `(show_id, season_number, episode_number)` 建唯一索引
  - 使用 upsert/ignore 冲突
- **验收标准**:
  - 重复爬取不会新增重复记录
  - 相关测试通过

### 中优先级 (Medium)

#### T-04 分页与过滤一致性
- **问题**: status 过滤先分页再内存过滤，total 不准
- **影响**: 前端分页错误
- **范围**: `api/show.go`, `repositories/show.go`
- **建议方案**:
  - Repo 层支持按 status 查询/分页
- **验收标准**:
  - total/page 与过滤条件一致

#### T-05 日期范围/时区统一
- **问题**: `Truncate(24h)` 本地时区导致边界偏差
- **影响**: 日期范围统计不准
- **范围**: `services/publisher.go`, `repositories/episode.go`
- **建议方案**:
  - 统一时区(UTC 或配置)
  - 明确定义闭区间/开区间
- **验收标准**:
  - 边界日期准确、文档明确

#### T-06 Cron 解析一致性
- **问题**: 校验使用 `ParseStandard` 不支持秒
- **影响**: 合法表达式被误判
- **范围**: `services/scheduler.go`
- **建议方案**:
  - 与 `WithSeconds` 对齐使用 `cron.Parse`
- **验收标准**:
  - 秒级表达式校验通过

#### T-07 调度任务并发控制
- **问题**: goroutine 无限制并发
- **影响**: 长期运行资源堆积
- **范围**: `services/scheduler.go`
- **建议方案**:
  - worker/队列或互斥控制
- **验收标准**:
  - 同类任务不重复并发

#### T-08 SQLite 搜索兼容
- **问题**: SQLite 不支持 `ILIKE`
- **影响**: 搜索失效
- **范围**: `repositories/show.go`
- **建议方案**:
  - 按 DB 类型选择 `LIKE/ILIKE`
  - 或统一 `LOWER(name) LIKE ?`
- **验收标准**:
  - SQLite/PG 均可搜索

#### T-09 Markdown 季排序稳定
- **问题**: season 未排序输出不稳定
- **影响**: 文档可读性
- **范围**: `services/markdown.go`
- **建议方案**:
  - seasons 排序后输出
- **验收标准**:
  - 顺序稳定

### 低优先级 (Low)

#### T-10 前端 API Key 存储安全
- **问题**: localStorage 可被 XSS 读取
- **影响**: 安全风险
- **范围**: `web/js/api.js`
- **建议方案**:
  - 短期 token + httpOnly cookie
  - 前端 XSS 防护
- **验收标准**:
  - 不在 localStorage 存密钥

#### T-11 配置校验补全
- **问题**: 端口范围/密码校验不完善
- **影响**: 配置错误风险
- **范围**: `config/config.go`
- **建议方案**:
  - 端口范围校验
  - DB 配置完整性校验
- **验收标准**:
  - 关键配置校验覆盖

#### T-12 Auth 失败记录清理
- **问题**: `failedAttempts` map 永不清理
- **影响**: 内存增长
- **范围**: `middleware/auth.go`
- **建议方案**:
  - 定期清理过期记录
  - 或设置最大容量
- **验收标准**:
  - 长期运行内存稳定

## 建议测试补充
- CreateBatch 去重/幂等性测试
- status 过滤 + 分页一致性测试
- GetTodayUpdates 时区边界测试
- Markdown 输出顺序稳定性测试

## 风险与优先级摘要
- **高风险**: T-01, T-02, T-03
- **中风险**: T-04 ~ T-09
- **低风险**: T-10 ~ T-12
