# Bug 修复：刷新剧集数据一致性问题

## 问题描述

当刷新剧集失败时（例如 TMDB API 超时、网络错误等），可能出现：
- 剧集基本信息（名称、状态、评分）已更新
- 但 `LastCrawledAt` 时间戳未更新
- 导致数据不一致，用户看到"部分刷新"的状态

## 根本原因

在 `services/crawler.go` 的 `CrawlShow` 函数中，原来的执行顺序是：

```
1. 获取 TMDB 剧集数据
2. 更新数据库中的剧集信息  ← 已写入
3. 爬取各季/集数据         ← 如果这里失败
4. 更新 LastCrawledAt      ← 不会执行
```

如果第 3 步失败，直接返回错误，但第 2 步已经写入数据库了。

## 修复方案

修改后的执行顺序：

```
1. 获取 TMDB 剧集数据       ← 先获取所有数据
2. 获取所有季/集数据        ← 在写入数据库前
3. 确认所有数据获取成功
4. 写入剧集信息
5. 写入季/集数据
6. 更新 LastCrawledAt
```

**核心原则**：先获取所有数据，确认成功后再写入数据库。如果任何步骤失败，不会修改任何数据库记录。

## 修改文件

- `services/crawler.go:53-239` - `CrawlShow` 函数

## 测试验证

```bash
# 重新编译
go build

# 重启服务
./go-tmdb-crawler

# 测试场景
1. 刷新一个不存在的剧集 (TMDB ID: 99999999)
   - 预期：返回错误，数据库不变

2. 刷新一个正常的剧集
   - 预期：所有信息更新成功，LastCrawledAt 更新

3. 断网后刷新剧集
   - 预期：返回错误，数据库不变
```

## 向后兼容性

此修改：
- ✅ 不改变 API 接口
- ✅ 不改变数据库结构
- ✅ 不影响其他功能
- ✅ 仅改进数据一致性

## 相关代码

- `api/show.go:187-217` - RefreshShow API 处理
- `services/crawler.go:53-239` - CrawlShow 核心逻辑
