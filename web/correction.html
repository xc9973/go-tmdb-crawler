<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self';">
    <title>数据纠错 - TMDB剧集管理</title>
    <link href="css/main-minimal.css?v=1.1" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .health-card { background: var(--bg-card); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; }
        .health-card h3 { margin: 0 0 0.75rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
        .stats { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .stats span { color: var(--text-muted); }
        .stats strong { color: var(--text-primary); margin-left: 0.25rem; }
        .warning { color: var(--warning); }
        .success { color: var(--success); }
        .actions { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .last-check { font-size: 0.85rem; color: var(--text-muted); }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-tv"></i> TMDB剧集管理</a>
            <button class="navbar-toggler" id="navbarToggle"><i class="bi bi-list"></i></button>
            <div class="navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li><a class="nav-link" href="/">剧集列表</a></li>
                    <li><a class="nav-link" href="/today.html">今日更新</a></li>
                    <li><a class="nav-link" href="/logs.html">爬取日志</a></li>
                    <li><a class="nav-link active" href="/correction.html">数据纠错</a></li>
                    <li><a class="nav-link" href="/backup.html">数据备份</a></li>
                </ul>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="theme-toggle" id="themeToggle" title="切换主题"></button>
                    <button class="btn btn-sm" id="loginLogoutBtn" onclick="handleAuthClick()">
                        <i class="bi bi-box-arrow-in-right"></i> 登录
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container-fluid" style="padding-top: 1.5rem;">
        <!-- 标题和操作 -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.25rem;"><i class="bi bi-check-circle text-primary"></i> 数据纠错</h2>
                            <span style="color: var(--text-muted); font-size: 0.85rem;">自动检测并修复过期剧集数据</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" id="runCorrectionBtn">
                                <i class="bi bi-arrow-clockwise"></i> 立即检测
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 健康状态卡片 -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="health-card">
                    <h3><i class="bi bi-activity"></i> 数据健康状态</h3>
                    <div class="stats">
                        <span>总剧集: <strong id="totalCount">-</strong></span>
                        <span>过期: <strong class="warning" id="staleCount">-</strong></span>
                        <span>正常: <strong class="success" id="normalCount">-</strong></span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-sm" onclick="location.href='#staleList'">查看过期剧集</button>
                        <button class="btn btn-sm" id="runDetectionBtn"><i class="bi bi-play"></i> 立即检测</button>
                    </div>
                    <div class="last-check" id="lastCheck">上次检测: 未运行</div>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loadingSpinner" class="text-center my-5" style="display: none;">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: var(--text-muted);">检测中...</p>
        </div>

        <!-- 过期剧集列表 -->
        <div class="row" id="staleList">
            <div class="col-12">
                <div class="card" style="padding: 0;">
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <h3 style="margin: 0; font-size: 1.1rem;"><i class="bi bi-exclamation-triangle text-warning"></i> 过期剧集列表</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="staleTable">
                            <thead>
                                <tr>
                                    <th>剧集名称</th>
                                    <th>海报</th>
                                    <th>正常间隔</th>
                                    <th>最新一集日期</th>
                                    <th>逾期天数</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="staleTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">暂无过期剧集</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/bundle-minimal.js?v=1.1"></script>
    <script src="js/correction.js?v=1.0"></script>
    <script>
        // 简单的认证UI处理
        function handleAuthClick() {
            const btn = document.getElementById('loginLogoutBtn');
            if (btn.innerHTML.includes('退出')) {
                if (confirm('确定要退出登录吗？')) {
                    fetch('/api/v1/auth/logout', { method: 'POST', credentials: 'include' })
                        .then(() => window.location.href = '/login.html');
                }
            } else {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
            }
        }

        // 检查登录状态并更新按钮
        fetch('/api/v1/auth/session', { credentials: 'include' })
            .then(r => r.json())
            .then(data => {
                if (data.code === 200) {
                    document.getElementById('loginLogoutBtn').innerHTML = '<i class="bi bi-box-arrow-right"></i> 退出';
                }
            })
            .catch(() => {});
    </script>
</body>
</html>
