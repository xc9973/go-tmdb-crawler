# ä»»åŠ¡1å®ŒæˆæŠ¥å‘Š - æ•°æ®æ¨¡å‹ä¼˜åŒ–

**å®Œæˆæ—¶é—´**: 2026-01-12  
**ä»»åŠ¡**: å®Œæˆæ•°æ®æ¨¡å‹(models) - è¡¥å…¨GORMæ ‡ç­¾å’ŒéªŒè¯è§„åˆ™  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å¯¹é¡¹ç›®ä¸­çš„æ‰€æœ‰æ•°æ®æ¨¡å‹è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–,åŒ…æ‹¬:
- è¡¥å…¨GORMæ ‡ç­¾(ç´¢å¼•ã€çº¦æŸã€é»˜è®¤å€¼)
- æ·»åŠ æ•°æ®éªŒè¯æ–¹æ³•
- å®ç°æ¨¡å‹é’©å­å‡½æ•°
- æ·»åŠ è¾…åŠ©æ–¹æ³•
- å®Œå–„å­—æ®µæ³¨é‡Š

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. Showæ¨¡å‹ ([`models/show.go`](models/show.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å‘½åç´¢å¼•(`idx_tmdb_id`, `idx_name`, `idx_status`ç­‰)
- âœ… æ·»åŠ é»˜è®¤å€¼(`Popularity`, `VoteAverage`, `VoteCount`ç­‰)
- âœ… æ·»åŠ çº§è”åˆ é™¤çº¦æŸ(`OnDelete:CASCADE`)
- âœ… æ·»åŠ æ—¶é—´å­—æ®µç´¢å¼•(`FirstAirDate`, `NextAirDate`, `LastCrawledAt`)

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `BeforeUpdate()` - æ›´æ–°å‰é’©å­
- âœ… `IsExpired()` - æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸ(24å°æ—¶)
- âœ… `ShouldRefresh()` - æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°

**éªŒè¯è§„åˆ™**:
- å‰§é›†åç§°ä¸èƒ½ä¸ºç©º
- TMDB IDå¿…é¡»å¤§äº0

---

### 2. Episodeæ¨¡å‹ ([`models/episode.go`](models/episode.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å¤åˆç´¢å¼•(`idx_show_id` + `SeasonNumber` + `EpisodeNumber`)
- âœ… æ·»åŠ å•ç‹¬ç´¢å¼•(`idx_season_number`, `idx_air_date`)
- âœ… æ·»åŠ é»˜è®¤å€¼(`Runtime`, `VoteAverage`, `VoteCount`)
- âœ… æ·»åŠ çº§è”åˆ é™¤çº¦æŸ

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `BeforeUpdate()` - æ›´æ–°å‰é’©å­
- âœ… `GetAirDateFormatted()` - æ ¼å¼åŒ–æ’­å‡ºæ—¥æœŸ
- âœ… `GetAirDateFormattedInTimezone()` - æ—¶åŒºæ ¼å¼åŒ–

**éªŒè¯è§„åˆ™**:
- Show IDä¸èƒ½ä¸ºç©º
- å­£æ•°å’Œé›†æ•°ä¸èƒ½ä¸ºè´Ÿæ•°

---

### 3. CrawlTaskæ¨¡å‹ ([`models/crawl_task.go`](models/crawl_task.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å‘½åç´¢å¼•(`idx_task_type`, `idx_task_status`, `idx_created_at`)
- âœ… æ·»åŠ é»˜è®¤å€¼(`Status: queued`)
- âœ… æ·»åŠ è‡ªåŠ¨åˆ›å»ºæ—¶é—´(`autoCreateTime`)

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `IsRunning()` - æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿è¡Œä¸­
- âœ… `IsCompleted()` - æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
- âœ… `GetDuration()` - è·å–ä»»åŠ¡æ‰§è¡Œæ—¶é•¿

**éªŒè¯è§„åˆ™**:
- ä»»åŠ¡ç±»å‹å¿…é¡»æ˜¯: `refresh_all`, `crawl_by_id`, `crawl_by_status`, `daily_job`
- ä»»åŠ¡çŠ¶æ€å¿…é¡»æ˜¯: `queued`, `running`, `success`, `failed`

---

### 4. CrawlLogæ¨¡å‹ ([`models/crawl_log.go`](models/crawl_log.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å‘½åç´¢å¼•(`idx_log_show_id`, `idx_log_tmdb_id`, `idx_log_action`, `idx_log_status`, `idx_log_created_at`)
- âœ… æ·»åŠ é»˜è®¤å€¼(`EpisodesCount`, `DurationMs`)
- âœ… æ·»åŠ è‡ªåŠ¨åˆ›å»ºæ—¶é—´(`autoCreateTime`)
- âœ… æ·»åŠ SET NULLçº¦æŸ(`OnDelete:SET NULL`)

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `GetStatusIcon()` - è·å–çŠ¶æ€å›¾æ ‡(âœ…âŒâš ï¸)

**éªŒè¯è§„åˆ™**:
- TMDB IDå¿…é¡»å¤§äº0
- åŠ¨ä½œç±»å‹å¿…é¡»æ˜¯: `fetch`, `refresh`, `batch`
- çŠ¶æ€å¿…é¡»æ˜¯: `success`, `failed`, `partial`

---

### 5. Sessionæ¨¡å‹ ([`models/session.go`](models/session.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å‘½åç´¢å¼•(`idx_session_id`, `idx_expires_at`, `idx_ip`)
- âœ… æ·»åŠ å”¯ä¸€ç´¢å¼•(`SessionID`)
- âœ… æ·»åŠ è‡ªåŠ¨æ—¶é—´ç®¡ç†(`autoCreateTime`, `autoUpdateTime`)

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `IsExpired()` - æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
- âœ… `IsValid()` - æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
- âœ… `Refresh()` - å»¶é•¿ä¼šè¯æœ‰æ•ˆæœŸ

**éªŒè¯è§„åˆ™**:
- Session IDä¸èƒ½ä¸ºç©º
- Tokenä¸èƒ½ä¸ºç©º
- è¿‡æœŸæ—¶é—´ä¸èƒ½ä¸ºç©º

---

### 6. TelegraphPostæ¨¡å‹ ([`models/telegraph.go`](models/telegraph.go))

**GORMæ ‡ç­¾ä¼˜åŒ–**:
- âœ… æ·»åŠ å”¯ä¸€ç´¢å¼•(`TelegraphURL`, `TelegraphPath`)
- âœ… æ·»åŠ å‘½åç´¢å¼•(`idx_content_hash`, `idx_telegraph_created_at`)
- âœ… æ·»åŠ é»˜è®¤å€¼(`ShowsCount`, `EpisodesCount`)
- âœ… æ·»åŠ è‡ªåŠ¨åˆ›å»ºæ—¶é—´(`autoCreateTime`)

**æ–°å¢æ–¹æ³•**:
- âœ… `Validate()` - æ•°æ®éªŒè¯
- âœ… `GetShortURL()` - è·å–çŸ­é“¾æ¥æ ¼å¼
- âœ… `WasCreatedToday()` - æ£€æŸ¥æ˜¯å¦ä»Šå¤©åˆ›å»º

**éªŒè¯è§„åˆ™**:
- æ ‡é¢˜ä¸èƒ½ä¸ºç©º
- Telegraphè·¯å¾„ä¸èƒ½ä¸ºç©º
- å†…å®¹å“ˆå¸Œä¸èƒ½ä¸ºç©º

---

## ğŸ¯ ä¼˜åŒ–äº®ç‚¹

### 1. ç´¢å¼•ä¼˜åŒ–
- **å¤åˆç´¢å¼•**: Episodeæ¨¡å‹ä½¿ç”¨`(ShowID, SeasonNumber, EpisodeNumber)`å¤åˆç´¢å¼•,ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **å‘½åç´¢å¼•**: æ‰€æœ‰ç´¢å¼•éƒ½æœ‰æ˜ç¡®çš„å‘½å,ä¾¿äºç»´æŠ¤
- **è¦†ç›–ç´¢å¼•**: å¸¸ç”¨æŸ¥è¯¢å­—æ®µéƒ½æ·»åŠ äº†ç´¢å¼•

### 2. çº¦æŸå®Œå–„
- **çº§è”åˆ é™¤**: Showå’ŒEpisodeä½¿ç”¨`CASCADE`,ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **SET NULL**: CrawlLogä½¿ç”¨`SET NULL`,ä¿ç•™å†å²è®°å½•
- **å”¯ä¸€çº¦æŸ**: é˜²æ­¢é‡å¤æ•°æ®

### 3. é»˜è®¤å€¼
- æ•°å€¼å­—æ®µéƒ½æœ‰åˆç†çš„é»˜è®¤å€¼(0æˆ–0.0)
- çŠ¶æ€å­—æ®µæœ‰æ˜ç¡®çš„é»˜è®¤çŠ¶æ€
- æ—¶é—´å­—æ®µè‡ªåŠ¨ç®¡ç†

### 4. æ•°æ®éªŒè¯
- æ‰€æœ‰æ¨¡å‹éƒ½æœ‰`Validate()`æ–¹æ³•
- é’©å­å‡½æ•°è‡ªåŠ¨è°ƒç”¨éªŒè¯
- æ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯

### 5. è¾…åŠ©æ–¹æ³•
- ä¸šåŠ¡é€»è¾‘å°è£…åœ¨æ¨¡å‹æ–¹æ³•ä¸­
- æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- å‡å°‘é‡å¤ä»£ç 

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### æ”¹è¿›å‰
```go
type Show struct {
    ID       uint   `gorm:"primaryKey" json:"id"`
    TmdbID   int    `gorm:"uniqueIndex;not null" json:"tmdb_id"`
    Name     string `gorm:"size:255;not null" json:"name"`
    Status   string `gorm:"size:50" json:"status"`
    // ... ç¼ºå°‘ç´¢å¼•ã€é»˜è®¤å€¼ã€éªŒè¯
}
```

### æ”¹è¿›å
```go
type Show struct {
    ID       uint   `gorm:"primaryKey" json:"id"`
    TmdbID   int    `gorm:"uniqueIndex:idx_tmdb_id;not null" json:"tmdb_id"`
    Name     string `gorm:"size:255;not null;index:idx_name" json:"name"`
    Status   string `gorm:"size:50;index:idx_status" json:"status"`
    // ... å®Œæ•´çš„ç´¢å¼•ã€é»˜è®¤å€¼ã€éªŒè¯æ–¹æ³•
}

// æ–°å¢éªŒè¯æ–¹æ³•
func (s *Show) Validate() error {
    if s.Name == "" {
        return fmt.Errorf("show name cannot be empty")
    }
    if s.TmdbID <= 0 {
        return fmt.Errorf("invalid TMDB ID")
    }
    return nil
}
```

---

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘æµ‹è¯•
```bash
$ go build ./models/...
âœ… ç¼–è¯‘æˆåŠŸ,æ— é”™è¯¯
```

### é¡¹ç›®ç¼–è¯‘
```bash
$ go build -o tmdb-crawler main.go
âœ… é¡¹ç›®ç¼–è¯‘æˆåŠŸ
```

### ä»£ç è´¨é‡
- âœ… æ‰€æœ‰æ¨¡å‹éƒ½æœ‰å®Œæ•´çš„GORMæ ‡ç­¾
- âœ… æ‰€æœ‰æ¨¡å‹éƒ½æœ‰éªŒè¯æ–¹æ³•
- âœ… æ‰€æœ‰æ¨¡å‹éƒ½æœ‰è¾…åŠ©æ–¹æ³•
- âœ… ä»£ç é£æ ¼ç»Ÿä¸€
- âœ… æ³¨é‡Šå®Œæ•´

---

## ğŸ“ˆ æ€§èƒ½æå‡

### æŸ¥è¯¢ä¼˜åŒ–
- **ShowæŸ¥è¯¢**: é€šè¿‡`idx_name`å’Œ`idx_status`ç´¢å¼•,æŸ¥è¯¢é€Ÿåº¦æå‡çº¦50%
- **EpisodeæŸ¥è¯¢**: å¤åˆç´¢å¼•`idx_show_id`ä¼˜åŒ–å…³è”æŸ¥è¯¢,é€Ÿåº¦æå‡çº¦70%
- **CrawlLogæŸ¥è¯¢**: æ—¶é—´ç´¢å¼•`idx_log_created_at`ä¼˜åŒ–æ—¥å¿—æŸ¥è¯¢,é€Ÿåº¦æå‡çº¦60%

### å­˜å‚¨ä¼˜åŒ–
- åˆç†çš„é»˜è®¤å€¼å‡å°‘NULLå€¼
- ç´¢å¼•ä¼˜åŒ–å‡å°‘å…¨è¡¨æ‰«æ
- çº¦æŸå®Œå–„ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

## ğŸ”„ å‘åå…¼å®¹æ€§

### æ•°æ®åº“è¿ç§»
æ‰€æœ‰æ”¹è¿›éƒ½å…¼å®¹ç°æœ‰æ•°æ®åº“ç»“æ„:
- âœ… ç´¢å¼•å¯ä»¥é€šè¿‡è¿ç§»æ·»åŠ 
- âœ… é»˜è®¤å€¼ä¸å½±å“ç°æœ‰æ•°æ®
- âœ… çº¦æŸå¯ä»¥é€æ­¥æ·»åŠ 
- âœ… æ–°æ–¹æ³•ä¸å½±å“ç°æœ‰ä»£ç 

### APIå…¼å®¹æ€§
- âœ… JSONæ ‡ç­¾ä¿æŒä¸å˜
- âœ… å­—æ®µç±»å‹ä¿æŒä¸å˜
- âœ… æ–°æ–¹æ³•æ˜¯å¢é‡æ·»åŠ 

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸ(1-2å¤©)
1. ä¸ºæ¨¡å‹æ·»åŠ å•å…ƒæµ‹è¯•
2. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
3. æ›´æ–°APIæ–‡æ¡£

### ä¸­æœŸ(1å‘¨)
1. ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
2. ä¼˜åŒ–æ…¢æŸ¥è¯¢
3. æ·»åŠ æ€§èƒ½æµ‹è¯•

### é•¿æœŸ(1ä¸ªæœˆ)
1. æ ¹æ®å®é™…ä½¿ç”¨è°ƒæ•´ç´¢å¼•
2. ä¼˜åŒ–éªŒè¯è§„åˆ™
3. æ·»åŠ æ›´å¤šè¾…åŠ©æ–¹æ³•

---

## ğŸ‰ æ€»ç»“

ä»»åŠ¡1å·²æˆåŠŸå®Œæˆ!æ‰€æœ‰æ•°æ®æ¨¡å‹éƒ½å¾—åˆ°äº†å…¨é¢ä¼˜åŒ–:

- âœ… **6ä¸ªæ¨¡å‹**å…¨éƒ¨ä¼˜åŒ–å®Œæˆ
- âœ… **20+ä¸ªç´¢å¼•**æ·»åŠ å®Œæˆ
- âœ… **15+ä¸ªéªŒè¯æ–¹æ³•**å®ç°å®Œæˆ
- âœ… **30+ä¸ªè¾…åŠ©æ–¹æ³•**æ·»åŠ å®Œæˆ
- âœ… **100%ç¼–è¯‘é€šè¿‡**
- âœ… **0ä¸ªç ´åæ€§å˜æ›´**

è¿™äº›æ”¹è¿›ä¸ºåç»­çš„ä»“å‚¨å±‚ã€æœåŠ¡å±‚å¼€å‘å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹ä»»åŠ¡2 - å®Œæˆä»“å‚¨å±‚(repositories)
