# 设计文档：前端状态反馈体验增强

## 背景与目标
当前 Web 端已具备基础的加载 Spinner 与 Toast，但在批量操作进度、错误提示友好度、确认交互一致性、失败重试等方面体验不足。本设计以最小改动为原则，提升以下体验：
- API 加载与批量操作的可见进度
- 统一且友好的错误提示
- 与 Bootstrap 风格一致的确认对话框
- 网络/服务异常的可重试能力

## 设计原则
- 最小改动与渐进增强
- 不引入新依赖，保持 Bootstrap 风格一致
- 复用现有 Toast/Spinner 能力
- 行为兼容现有逻辑

## 方案选择
采用“方案 A：渐进增强”。在现有代码基础上新增统一反馈模块，并在关键交互点逐步迁移。

## 模块与组件设计
新增 `web/js/feedback.js`，导出统一入口：
- ProgressBar：批量操作进度展示
- ErrorHandler：错误信息友好化
- ConfirmDialog：统一确认对话框
- RetryHandler：请求失败重试装饰器

## 数据流示例（批量刷新）
1. 用户触发批量刷新
2. ConfirmDialog 确认
3. ProgressBar.start(total)
4. 顺序执行刷新并更新进度（成功/失败计数）
5. ProgressBar.complete(summary)

## 错误处理策略
- 网络错误/超时：自动重试（默认 3 次），仍失败提示“可重试”
- 401：触发登录流程，并提示“登录已过期”
- 4xx：显示业务消息或友好提示
- 5xx：重试后提示“服务器繁忙”

## 变更点（最小化）
- `web/index.html`：引入 `feedback.js`；增加进度条容器与确认对话框模板
- `web/js/api.js`：请求错误统一处理；支持可配置重试
- `web/js/shows.js`：替换 `confirm()`；批量操作接入进度条

## 测试计划（最小可行）
- 批量操作进度与完成统计
- 确认对话框确认/取消
- 错误提示映射与兜底
- 重试成功/失败路径

## 风险与回退
- 风险：新组件与现有逻辑耦合不当
- 回退：保留原 `showToast`/`showLoading`，可逐项回滚到旧逻辑
