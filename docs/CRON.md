# Cron 表达式配置指南

## 概述

本项目使用 `robfig/cron/v3` 库来管理定时任务。调度器支持 **6字段** 的 Cron 表达式格式，包含秒级精度。

## Cron 表达式格式

### 6字段格式（支持秒）

```
┌───────────── 秒 (0 - 59)
│ ┌─────────── 分钟 (0 - 59)
│ │ ┌───────── 小时 (0 - 23)
│ │ │ ┌─────── 日期 (1 - 31)
│ │ │ │ ┌───── 月份 (1 - 12)
│ │ │ │ │ ┌─── 星期 (0 - 6, 0 = 周日)
│ │ │ │ │ │
* * * * * *
```

### 字段说明

| 字段 | 允许值 | 特殊字符 |
|------|--------|----------|
| 秒   | 0-59   | `*` `,` `-` `/` |
| 分钟 | 0-59   | `*` `,` `-` `/` |
| 小时 | 0-23   | `*` `,` `-` `/` |
| 日期 | 1-31   | `*` `,` `-` `/` `?` |
| 月份 | 1-12   | `*` `,` `-` `/` |
| 星期 | 0-6    | `*` `,` `-` `/` `?` |

### 特殊字符

| 字符 | 含义 | 示例 |
|------|------|------|
| `*`  | 所有值 | `* * * * * *` - 每秒执行 |
| `,`  | 列表分隔符 | `0 0 8,12,20 * * *` - 每天 8:00:00, 12:00:00, 20:00:00 执行 |
| `-`  | 范围 | `0 0 8-18 * * *` - 每天 8:00:00 到 18:00:00 每小时执行 |
| `/`  | 步长 | `*/5 * * * * *` - 每 5 秒执行 |
| `?`  | 不指定值（仅用于日期和星期） | `0 0 0 ? * *` - 不指定具体日期 |

## 预定义描述符

项目支持以下预定义的时间描述符：

| 描述符 | 等价表达式 | 说明 |
|--------|-----------|------|
| `@yearly` 或 `@annually` | `0 0 0 1 1 *` | 每年 1月1日 00:00:00 |
| `@monthly` | `0 0 0 1 * *` | 每月 1日 00:00:00 |
| `@weekly` | `0 0 0 * * 0` | 每周日 00:00:00 |
| `@daily` 或 `@midnight` | `0 0 0 * * *` | 每天 00:00:00 |
| `@hourly` | `0 0 * * * *` | 每小时 00:00:00 |

## 默认调度任务

项目预配置了以下调度任务：

### 每日爬取任务
```cron
0 0 8,12,20 * * *
```
- **说明**: 每天 8:00:00, 12:00:00, 20:00:00 执行
- **功能**: 刷新所有正在播出的剧集

### 每日发布任务
```cron
0 30 20 * * *
```
- **说明**: 每天 20:30:00 执行
- **功能**: 发布今日更新到 Telegraph

### 每周爬取任务
```cron
0 0 6 * * 1
```
- **说明**: 每周一 06:00:00 执行
- **功能**: 完整刷新所有剧集

### 每周发布任务
```cron
0 0 7 * * 1
```
- **说明**: 每周一 07:00:00 执行
- **功能**: 发布过去7天的更新到 Telegraph

## 常用示例

### 基本示例

```cron
# 每 5 秒执行
*/5 * * * * *

# 每分钟的第 0 秒执行
0 * * * * *

# 每小时的第 0 分 0 秒执行
0 0 * * * *

# 每天的 00:00:00 执行
0 0 0 * * *

# 每月 1 日的 00:00:00 执行
0 0 0 1 * *

# 每周日的 00:00:00 执行
0 0 0 * * 0
```

### 复杂示例

```cron
# 工作日（周一到周五）每天 8:00:00 到 18:00:00 每小时执行
0 0 8-18 * * 1-5

# 每 10 分钟执行
0 */10 * * * *

# 每月最后一天的 23:59:59 执行
59 59 23 28-31 * *

# 每周周一、周三、周五的 12:00:00 执行
0 0 12 * * 1,3,5

# 每天上午 9 点到下午 5 点，每 2 小时执行一次
0 0 9-17/2 * * *
```

## Cron 表达式验证

### 使用 ValidateCronSpec 函数

项目提供了 `ValidateCronSpec` 函数来验证 Cron 表达式的有效性：

```go
import "github.com/xc9973/go-tmdb-crawler/services"

// 验证 Cron 表达式
err := services.ValidateCronSpec("0 0 8 * * *")
if err != nil {
    // 表达式无效
    log.Printf("Invalid cron spec: %v", err)
}
```

### 验证规则

1. **必须使用 6 字段格式**（包含秒）
2. **不支持 5 字段格式**（不包含秒）
3. **数值必须在有效范围内**
4. **支持预定义描述符**（@yearly, @monthly 等）

### 错误示例

```cron
# ❌ 错误：5 字段格式（缺少秒）
0 8 * * *

# ❌ 错误：秒超出范围
60 * * * * *

# ❌ 错误：分钟超出范围
0 60 * * * *

# ❌ 错误：小时超出范围
0 0 24 * * *

# ❌ 错误：日期超出范围
0 0 0 32 * *

# ❌ 错误：月份超出范围
0 0 0 1 13 *

# ❌ 错误：星期超出范围
0 0 0 * * 8
```

## 时区配置

Cron 任务使用配置的时区执行。默认使用 UTC 时区。

### 配置时区

在 `.env` 文件中设置：

```bash
# 使用 UTC 时区（默认）
SCHEDULER_TZ=UTC

# 使用中国时区
SCHEDULER_TZ=Asia/Shanghai

# 使用美国东部时区
SCHEDULER_TZ=America/New_York
```

### 时区影响

时区配置会影响任务的执行时间。例如：

```cron
# 在 UTC 时区下，每天 8:00:00 执行
0 0 8 * * *

# 在 Asia/Shanghai 时区下，每天 8:00:00 执行
# 相当于 UTC 0:00:00
0 0 8 * * *
```

## 自定义调度任务

### 添加自定义任务

```go
import (
    "github.com/robfig/cron/v3"
    "github.com/xc9973/go-tmdb-crawler/services"
)

// 创建调度器
scheduler := services.NewScheduler(crawler, publisher, logger)

// 添加自定义任务
spec := "0 */30 * * * *" // 每 30 分钟执行
job := func() {
    // 自定义任务逻辑
}

id, err := scheduler.AddCustomJob(spec, job)
if err != nil {
    log.Printf("Failed to add custom job: %v", err)
}
```

### 移除任务

```go
scheduler.RemoveJob(id)
```

## 最佳实践

### 1. 使用秒级精度

由于项目使用 `cron.WithSeconds()` 选项，所有 Cron 表达式必须包含秒字段：

```cron
# ✅ 正确：6 字段格式
0 0 8 * * *

# ❌ 错误：5 字段格式
0 8 * * *
```

### 2. 避免任务重叠

对于长时间运行的任务，建议使用互斥锁或任务队列：

```go
func (s *Scheduler) longRunningJob() {
    s.mu.Lock()
    defer s.mu.Unlock()
    
    // 任务逻辑
}
```

### 3. 合理设置执行间隔

避免设置过于频繁的执行间隔，以免造成系统负载过高：

```cron
# ✅ 推荐：每 5 分钟
0 */5 * * * *

# ⚠️ 谨慎使用：每秒
* * * * * *
```

### 4. 使用描述符提高可读性

对于常见的时间间隔，使用预定义描述符：

```cron
# ✅ 推荐：使用描述符
@daily

# ⚠️ 可读性较差
0 0 0 * * *
```

### 5. 验证表达式

在添加任务前，始终验证 Cron 表达式：

```go
if err := ValidateCronSpec(spec); err != nil {
    return fmt.Errorf("invalid cron spec: %w", err)
}
```

## 故障排查

### 问题：任务没有按预期执行

**可能原因**：
1. Cron 表达式格式错误
2. 时区配置不正确
3. 调度器未启动

**解决方案**：
1. 使用 `ValidateCronSpec` 验证表达式
2. 检查 `SCHEDULER_TZ` 配置
3. 确认调度器已启动：`scheduler.IsRunning()`

### 问题：5字段表达式被拒绝

**原因**：项目使用 `cron.WithSeconds()` 选项，要求 6 字段格式。

**解决方案**：在表达式前添加秒字段：

```cron
# 修改前（5 字段）
0 8 * * *

# 修改后（6 字段）
0 0 8 * * *
```

### 问题：任务执行时间不准确

**可能原因**：时区配置错误。

**解决方案**：
1. 检查 `.env` 文件中的 `SCHEDULER_TZ` 配置
2. 确认时区名称正确（区分大小写）
3. 参考 IANA 时区数据库使用正确的时区名称

## 相关文档

- [时区配置指南](TIMEZONE.md)
- [robfig/cron 文档](https://github.com/robfig/cron)
- [Cron 表达式在线测试工具](https://crontab.guru/)

## 注意事项

1. **6 字段格式**：本项目使用 6 字段 Cron 表达式，必须包含秒字段
2. **时区一致性**：确保 Cron 表达式和系统时区配置一致
3. **表达式验证**：添加任务前务必验证表达式格式
4. **性能考虑**：避免设置过于频繁的执行间隔
5. **错误处理**：任务执行失败时，错误会被记录到日志中
